<!DOCTYPE html>
<html>
<head>
  <title>Prescriptions</title>
</head>
<body>
  
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/app.css?v=20251103004732" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <nav id="main-navbar-hm" class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4" role="navigation" aria-label="Main navigation">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center text-decoration-none" href="/dashboard">
                <div class="brand-badge px-2 py-1 me-2" aria-hidden="true">HM</div>
                <div class="d-flex flex-column">
                    <span class="fw-bold">Hospital Management</span>
                    <small class="muted">Comprehensive â€¢ Caring â€¢ Efficient</small>
                </div>
            </a>

            <!-- quick-actions removed to simplify navbar visual - was: New Patient / Appointments / Billing buttons -->

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
                    <li class="nav-item"><a class="nav-link " href="/dashboard">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link " href="/patients">Patients</a></li>
                    <li class="nav-item"><a class="nav-link " href="/appointments">Appointments</a></li>
                    <li class="nav-item"><a class="nav-link " href="/doctors">Doctors</a></li>
                    <li class="nav-item"><a class="nav-link " href="/departments">Departments</a></li>
                    <li class="nav-item"><a class="nav-link " href="/admissions">Admissions</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/prescriptions">Prescriptions</a></li>
                    <li class="nav-item"><a class="nav-link " href="/billing">Billing</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <script>
      (function(){
        // Robust duplicate-navbar remover:
        // - Ensures only the first navbar with the same brand text stays.
        // - Works even if header fragments are inserted later by observing DOM mutations.

        function removeDuplicateNavbars(){
          try{
            var navs = Array.prototype.slice.call(document.querySelectorAll('nav[id^="main-navbar-hm"]'));
            if(!navs || navs.length <= 1) return;

            // Use the first navbar as canonical. Remove any later navs that appear visually identical by brand text
            var canonical = navs[0];
            var canonicalBrand = (canonical.querySelector('.navbar-brand') || canonical).textContent.trim();

            for(var i = 1; i < navs.length; i++){
              var n = navs[i];
              var brand = (n.querySelector('.navbar-brand') || n).textContent.trim();
              // If brand matches (or if IDs clash), remove the duplicate instance.
              if(brand === canonicalBrand || n.id === canonical.id){
                n.parentNode && n.parentNode.removeChild(n);
              }
            }
          }catch(e){
            // no-op
          }
        }

        // Run on DOM ready
        if(document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', removeDuplicateNavbars);
        } else {
          // already ready
          removeDuplicateNavbars();
        }

        // Observe DOM for later additions (debounced)
        var observer;
        try{
          var debounce;
          observer = new MutationObserver(function(mutations){
            if(debounce) clearTimeout(debounce);
            debounce = setTimeout(removeDuplicateNavbars, 80);
          });
          observer.observe(document.documentElement || document.body, {childList:true, subtree:true});

          // Stop observing after some time (safety) - navbars won't be added after initial render in normal cases
          setTimeout(function(){ observer.disconnect(); }, 5000);
        }catch(e){ /* MutationObserver not supported - fine */ }
      })();
    </script>
  <div class="container">
    <div class="page-title"><span class="emoji">ðŸ’Š</span><h1 class="m-0">Prescriptions</h1></div>
    <div id="alertPlaceholder"></div>
    
    <div class="form-section mb-3">
      <form id="prescriptionForm" class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label visually-hidden">Patient</label>
          <select class="form-select" id="prPatientId" required>
            <option value="">Patient</option>
              <option value="1">Mayrielle Joy Latigo</option>
              <option value="3">John Michael Reyes</option>
              <option value="5">Maria Santos</option>
              <option value="6">Patricia Ann Dela Cruz</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label visually-hidden">Doctor</label>
          <select class="form-select" id="prDoctorId" required>
            <option value="">Doctor</option>
              <option value="1">Dr. Angela Mendoza</option>
              <option value="2">Dr. Liza Dominguez</option>
              <option value="3">Dr. Katrina Villanueva</option>
              <option value="4">Dr. Raymond Gutierrez</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label visually-hidden">Medications</label>
          <input class="form-control" id="prMedications" placeholder="Medications (comma separated)">
        </div>
        <div class="col-md-2">
          <button id="prAddBtn" class="btn btn-primary w-100" type="submit">Add</button>
        </div>
        <div class="col-12 mt-2"><input class="form-control" id="prNotes" placeholder="Notes"></div>
      </form>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead><tr><th>ID</th><th>Date</th><th>Patient</th><th>Doctor</th><th>Medications</th><th>Notes</th><th>Actions</th></tr></thead>
        <tbody>
            <tr data-prescription-id="1">
              <td>1</td>
              <td>2025-11-02</td>
              <td><a href="/patients/1">Mayrielle Joy Latigo</a></td>
              <td>Dr. Liza Dominguez <span class="muted small">(Obstetrics &amp; Gynecology)</span></td>
              <td>Paracetamol</td>
              <td></td>
              <td>
                <div class="d-flex gap-1">
                  <button class="btn btn-sm btn-danger pr-delete-btn" data-id="1">Delete</button>
                  <a href="/prescriptions/view/1" data-href="/prescriptions/view/1" class="btn btn-sm btn-outline-secondary pr-view-link">View</a>
                </div>
              </td>
            </tr>
                      <tr data-prescription-id="2">
              <td>2</td>
              <td>2025-11-02</td>
              <td><a href="/patients/3">John Michael Reyes</a></td>
              <td>Dr. Angela Mendoza <span class="muted small">(Cardiology)</span></td>
              <td>Ibuprofen</td>
              <td></td>
              <td>
                <div class="d-flex gap-1">
                  <button class="btn btn-sm btn-danger pr-delete-btn" data-id="2">Delete</button>
                  <a href="/prescriptions/view/2" data-href="/prescriptions/view/2" class="btn btn-sm btn-outline-secondary pr-view-link">View</a>
                </div>
              </td>
            </tr>
                      <tr data-prescription-id="3">
              <td>3</td>
              <td>2025-11-02</td>
              <td><a href="/patients/5">Maria Santos</a></td>
              <td>Dr. Katrina Villanueva <span class="muted small">(General Surgery)</span></td>
              <td>Insulin (Regular)</td>
              <td></td>
              <td>
                <div class="d-flex gap-1">
                  <button class="btn btn-sm btn-danger pr-delete-btn" data-id="3">Delete</button>
                  <a href="/prescriptions/view/3" data-href="/prescriptions/view/3" class="btn btn-sm btn-outline-secondary pr-view-link">View</a>
                </div>
              </td>
            </tr>
                  </tbody>
      </table>
    </div>
  </div>

  <script>
    (function(){
      const alertPlaceholder = document.getElementById('alertPlaceholder');
      // Robust navigation for View links: ensure anchors navigate via location.href to avoid accidental static-resource fetches
      document.querySelectorAll('.pr-view-link').forEach(a => a.addEventListener('click', function(e){
        // Let normal Ctrl/Cmd+click or middle-click behave naturally
        if (e.ctrlKey || e.metaKey || e.button === 1) return;
        e.preventDefault();
        const href = this.dataset.href || this.getAttribute('href');
        if(href) location.href = href;
      }));

      function showAlert(message, type){
        alertPlaceholder.innerHTML = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' + message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
      }

      const form = document.getElementById('prescriptionForm');
      form && form.addEventListener('submit', async function(e){
        e.preventDefault();
        const patientId = document.getElementById('prPatientId').value;
        const doctorId = document.getElementById('prDoctorId').value;
        const meds = document.getElementById('prMedications').value.trim();
        const notes = document.getElementById('prNotes').value.trim();
        if(!patientId || !doctorId || !meds){ showAlert('Patient, doctor and medications are required', 'warning'); return; }
        const payload = { patient: { id: Number(patientId) }, doctor: { id: Number(doctorId) }, medications: meds, notes: notes };
        try{
          const res = await fetch('/api/prescriptions', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
          if(res.ok){ showAlert('Prescription saved','success'); setTimeout(()=> location.reload(),700); }
          else { const txt = await res.text(); showAlert('Error: '+txt,'danger'); }
        }catch(err){ showAlert('Unexpected error: '+err.message,'danger'); }
      });

      // Delete buttons
      document.querySelectorAll('.pr-delete-btn').forEach(btn => btn.addEventListener('click', async function(e){
        const id = this.dataset.id;
        if(!confirm('Delete prescription?')) return;
        try{
          const res = await fetch('/api/prescriptions/'+id, { method: 'DELETE' });
          if(res.ok || res.status===204){ showAlert('Prescription deleted','success'); setTimeout(()=> location.reload(),500); }
          else { const txt = await res.text(); showAlert('Error: '+txt,'danger'); }
        }catch(err){ showAlert('Unexpected error: '+err.message,'danger'); }
      }));
    })();
  </script>

<footer class="footer py-4 mt-6 bg-light">
  <div class="container d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
      <div class="muted">&copy; 2025 Hospital Management</div>
      <small class="muted">All rights reserved.</small>
    </div>
    <div class="d-flex align-items-center gap-3">
      <a href="/dashboard" class="muted small">Dashboard</a>
      <a href="/patients" class="muted small">Patients</a>
      <a href="/appointments" class="muted small">Appointments</a>
      <a href="/prescriptions" class="muted small">Prescriptions</a>
    </div>
  </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
