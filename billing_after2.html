<!DOCTYPE html>
<html>
<head>
  <title>Billing</title>
</head>
<body>
  
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/app.css?v=20251103004733" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <nav id="main-navbar-hm" class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4" role="navigation" aria-label="Main navigation">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center text-decoration-none" href="/dashboard">
                <div class="brand-badge px-2 py-1 me-2" aria-hidden="true">HM</div>
                <div class="d-flex flex-column">
                    <span class="fw-bold">Hospital Management</span>
                    <small class="muted">Comprehensive â€¢ Caring â€¢ Efficient</small>
                </div>
            </a>

            <!-- quick-actions removed to simplify navbar visual - was: New Patient / Appointments / Billing buttons -->

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
                    <li class="nav-item"><a class="nav-link " href="/dashboard">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link " href="/patients">Patients</a></li>
                    <li class="nav-item"><a class="nav-link " href="/appointments">Appointments</a></li>
                    <li class="nav-item"><a class="nav-link " href="/doctors">Doctors</a></li>
                    <li class="nav-item"><a class="nav-link " href="/departments">Departments</a></li>
                    <li class="nav-item"><a class="nav-link " href="/admissions">Admissions</a></li>
                    <li class="nav-item"><a class="nav-link " href="/prescriptions">Prescriptions</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/billing">Billing</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <script>
      (function(){
        // Robust duplicate-navbar remover:
        // - Ensures only the first navbar with the same brand text stays.
        // - Works even if header fragments are inserted later by observing DOM mutations.

        function removeDuplicateNavbars(){
          try{
            var navs = Array.prototype.slice.call(document.querySelectorAll('nav[id^="main-navbar-hm"]'));
            if(!navs || navs.length <= 1) return;

            // Use the first navbar as canonical. Remove any later navs that appear visually identical by brand text
            var canonical = navs[0];
            var canonicalBrand = (canonical.querySelector('.navbar-brand') || canonical).textContent.trim();

            for(var i = 1; i < navs.length; i++){
              var n = navs[i];
              var brand = (n.querySelector('.navbar-brand') || n).textContent.trim();
              // If brand matches (or if IDs clash), remove the duplicate instance.
              if(brand === canonicalBrand || n.id === canonical.id){
                n.parentNode && n.parentNode.removeChild(n);
              }
            }
          }catch(e){
            // no-op
          }
        }

        // Run on DOM ready
        if(document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', removeDuplicateNavbars);
        } else {
          // already ready
          removeDuplicateNavbars();
        }

        // Observe DOM for later additions (debounced)
        var observer;
        try{
          var debounce;
          observer = new MutationObserver(function(mutations){
            if(debounce) clearTimeout(debounce);
            debounce = setTimeout(removeDuplicateNavbars, 80);
          });
          observer.observe(document.documentElement || document.body, {childList:true, subtree:true});

          // Stop observing after some time (safety) - navbars won't be added after initial render in normal cases
          setTimeout(function(){ observer.disconnect(); }, 5000);
        }catch(e){ /* MutationObserver not supported - fine */ }
      })();
    </script>
  <div class="container">
    <div class="d-flex align-items-center mb-3"><div class="page-title d-flex align-items-center gap-2"><span class="emoji">ðŸ’³</span><h1 class="m-0">Billing</h1></div><div class="ms-auto"><a href="/billing" class="btn btn-outline-secondary btn-sm">Refresh</a></div></div>
    <div id="alertPlaceholder"></div>
    

    <!-- Filter form (unchanged) -->
    <div class="card mb-3 form-section">
      <div class="card-body">
        <form action="/billing" method="get" class="row g-2 align-items-end">
          <div class="col-md-3">
            <select class="form-select form-select-sm" name="status">
              <option value="">Status (All)</option>
              <option value="UNPAID" >UNPAID</option>
              <option value="PAID" >PAID</option>
            </select>
          </div>
          <div class="col-md-3"><input class="form-control form-control-sm" type="date" name="from" value=""></div>
          <div class="col-md-3"><input class="form-control form-control-sm" type="date" name="to" value=""></div>
          <div class="col-md-2">
            <select class="form-select form-select-sm" name="patientId">
              <option value="">Patient (All)</option>
                <option value="1" >Mayrielle Joy Latigo</option>
                <option value="3" >John Michael Reyes</option>
                <option value="5" >Maria Santos</option>
                <option value="6" >Patricia Ann Dela Cruz</option>
            </select>
          </div>
          <div class="col-md-1"><button class="btn btn-outline-secondary btn-sm w-100">Filter</button></div>
        </form>
      </div>
    </div>

    <!-- Create invoice form (converted to REST) -->
    <div class="card mb-3 form-section">
      <div class="card-body">
        <form id="invoiceForm" class="row g-2 align-items-end">
          <div class="col-md-4">
            <select class="form-select form-select-sm" id="invPatientId" required>
              <option value="">Select Patient</option>
                <option value="1">Mayrielle Joy Latigo</option>
                <option value="3">John Michael Reyes</option>
                <option value="5">Maria Santos</option>
                <option value="6">Patricia Ann Dela Cruz</option>
            </select>
          </div>
          <div class="col-md-3"><input class="form-control form-control-sm" id="invAmount" placeholder="Amount" type="number" step="0.01" required></div>
          <div class="col-md-4"><input class="form-control form-control-sm" id="invDescription" placeholder="Description"></div>
          <div class="col-md-1"><button id="invCreateBtn" class="btn btn-primary btn-sm w-100" type="submit">Create</button></div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
          <thead class="table-light small"><tr><th>ID</th><th>Patient</th><th>Amount</th><th>Status</th><th>Issued</th><th>Paid</th><th>Actions</th></tr></thead>
          <tbody>
                <tr data-invoice-id="1">
                  <td>1</td>
                  <td>Mayrielle Joy Latigo</td>
                  <td>$1,000</td>
                  <td><span class="badge status-paid">PAID</span></td>
                  <td>2025-11-02 19:48</td>
                  <td>2025-11-02 19:51</td>
                  <td>
                  </td>
                </tr>
                <tr data-invoice-id="2">
                  <td>2</td>
                  <td>Maria Santos</td>
                  <td>$500</td>
                  <td><span class="badge status-unpaid">UNPAID</span></td>
                  <td>2025-11-02 19:49</td>
                  <td>-</td>
                  <td>
                      <button class="btn btn-sm btn-outline-success inv-pay-btn" data-id="2" title="Mark as Paid">Mark as Paid</button>
                  </td>
                </tr>
                <tr data-invoice-id="3">
                  <td>3</td>
                  <td>John Michael Reyes</td>
                  <td>$200</td>
                  <td><span class="badge status-unpaid">UNPAID</span></td>
                  <td>2025-11-02 19:49</td>
                  <td>-</td>
                  <td>
                      <button class="btn btn-sm btn-outline-success inv-pay-btn" data-id="3" title="Mark as Paid">Mark as Paid</button>
                  </td>
                </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const alertPlaceholder = document.getElementById('alertPlaceholder');
      function showAlert(message, type){
        alertPlaceholder.innerHTML = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' + message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
      }

      const invoiceForm = document.getElementById('invoiceForm');
      invoiceForm && invoiceForm.addEventListener('submit', async function(e){
        e.preventDefault();
        const patientId = Number(document.getElementById('invPatientId').value);
        const amount = parseFloat(document.getElementById('invAmount').value);
        const description = document.getElementById('invDescription').value.trim();
        if(!patientId || !amount){ showAlert('Patient and amount are required','warning'); return; }
        const payload = { patient: { id: patientId }, amount: amount, description: description };
        try{
          const res = await fetch('/api/invoices', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if(res.ok){ showAlert('Invoice created','success'); setTimeout(()=> location.reload(),700); }
          else { const txt = await res.text(); showAlert('Error: '+txt,'danger'); }
        }catch(err){ showAlert('Unexpected: '+err.message, 'danger'); }
      });

      // Mark as paid buttons
      document.querySelectorAll('.inv-pay-btn').forEach(btn => btn.addEventListener('click', async function(e){
        const id = this.dataset.id;
        if(!confirm('Mark invoice as paid?')) return;
        try{
          const res = await fetch('/api/invoices/'+id+'/paid', { method: 'PUT' });
          if(res.ok){ showAlert('Invoice marked as paid','success'); setTimeout(()=> location.reload(),500); }
          else { const txt = await res.text(); showAlert('Error: '+txt,'danger'); }
        }catch(err){ showAlert('Unexpected error: '+err.message,'danger'); }
      }));
    })();
  </script>

<footer class="footer py-4 mt-6 bg-light">
  <div class="container d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
      <div class="muted">&copy; 2025 Hospital Management</div>
      <small class="muted">All rights reserved.</small>
    </div>
    <div class="d-flex align-items-center gap-3">
      <a href="/dashboard" class="muted small">Dashboard</a>
      <a href="/patients" class="muted small">Patients</a>
      <a href="/appointments" class="muted small">Appointments</a>
      <a href="/prescriptions" class="muted small">Prescriptions</a>
    </div>
  </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
